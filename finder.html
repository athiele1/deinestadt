<html>
<head>
<link rel="shortcut icon" type="image/png" href="pics/logo_300.png"/>
<title>Bremen spendet</title>
<meta charset="utf-8"/>
<link rel="stylesheet" type="text/css" href="style.css">
<link href="https://fonts.googleapis.com/css?family=Oswald:400" rel="stylesheet">
<script src="main.js"></script>
</head>
<body>
<!--
<div class="introDivNO"><div class="introDivImageNO"><img src="pics/logo_200.png" width="100px" height="100px"></div></div>
-->
<div id="divHead"></div>
<div id="divContent">
  <h1>Was möchtest du spenden?</h1>
  <div id="divKat"></div>
  <h1>Deine Postleitzahl:</h1>
  <input type="text"  style="width:80px" id="plzInput" class="noFocus" oninput="plzCheck(this)" max = "99999" maxLength="5" onKeyPress="return isNumeric(event)">
  <span id="plzFound" style="color:green"></span>
  <br><br>
  <input type="button" id="los" class="losbutton1" value="Los!" onClick="los()">
  <br>
  <br>
  <!--<h1>Der "Spenden-Finder" ist noch in Arbeit.</h1>
    
    <div id="div350">
    <img src="pics/tea.png" width="350" height="260">
    Bis dahin heißt es abwarten und Spenden raussuchen.
    </div>-->
  
  <div id="map"></div>
</div>
<div id="divButtom"></div>
</body>
<script>
	//Die Google Map
    var infowindow,service,map;
	
	//Beinhaltet für jede Kategorie ein true/false, je nachdem ob es ausgewählt wurde
	var kategorien = [];
	
	//Eine Liste aller google maps marker
	var markers = [];
	
	
	//Eine Liste von Listen, welche für jeden Marker dessen Attribute  speichert ([name, bGrad, lGrad, adresse, spendenAnnahmen, spendenSpecials])
	var markerContent = [];
	
	
    addHeadMenu(document.getElementById("divHead"));
    addButtomMenu(document.getElementById("divButtom"));
    markButton(1);
    
	//Alle Kategorien
	var katLabels = ["Bücher","Elektronik","Möbel","Spielzeug","Haushaltswaren","Kleidung","Lebensmittel","Sonstiges"];
	
	//Die Pfade zu den Bildern der Kategorie (ohne Dateiendung)
	var katPaths = ["buch","elektronik","moebel","spielzeug","haushalt","kleidung","lebensmittel","sonstige"];
	
	//Passt die Pfade an
	for(var i = 0; i < katPaths.length; i++){
		katPaths[i] = 	pathLabelToPath(katPaths[i]);		
	}

	for(var i = 0; i < katLabels.length; i++){
		addKategorie(katLabels[i],katPaths[i]);
			
	}
	
	//Alle "Stadtteile", also PLZ plus Position
	var stadtteile = [];
	addAllPLZ();
	
	
	
	
	//"Klasse" für Stadteil
 	function Stadtteil(pplz, plgrad, pbgrad){
		this.plz = pplz;
		this.lgrad = plgrad;
		this.bgrad = pbgrad;
	}
	
	//Fügt Stadtteil hinzu
	function addStadtTeil(plz, lgrad, bgrad){
		
		var si = new Stadtteil(plz, lgrad, bgrad);

		stadtteile.push(si);
	}
	
	//Sobald der Knopf Los gedrückt wird
	function los(){
		
		var plzInput = document.getElementById("plzInput");
		var si = plzToStadtteil(plzInput.value);
		
		if(si != null){
			map.setZoom(13);
			map.setCenter(new google.maps.LatLng(si.lgrad, si.bgrad));	
			
			
		}
		window.scrollTo(0,document.body.scrollHeight);
		updateMarkers();
		
	}
	
	//Wandelt eine PLZ zum Stadteil um
	function plzToStadtteil(plz){
		var s = plz.toString();
	
		for(i in stadtteile){
			if(s == stadtteile[i].plz.toString()){
				return 	stadtteile[i];
			}
		}
		
		return null;
	}
	
	
	
	//Passt die Kategorien Bilder Pfade an
	function pathLabelToPath(katPath){
		return 	"pics/finder/c_" + katPath + ".png";
		
	}
	
	
	//Ersellt die klickbaren Kategorien Auswahlboxen
	function addKategorie(name, pfad){
	
		var nr = kategorien.length;
		
		
		var img = new Image();
		img.src = pfad;
		
		var btn = document.createElement("a");
		btn.name = name;
		btn.href = "JavaScript:clickKategorie(" + nr + ");";
		btn.className = "noFocus";
		
		img.id = "img_" + nr;
		img.className = "katImg";
		
		kategorien.push(false);
		
		
		btn.appendChild(img);
		
		
		
		var div = document.createElement("div");
		//div.className = "noFocus";
		
		div.className = "katDiv";
		
		var txt = document.createTextNode(name);
		//txt.style.textAlign = "center";		
		
		
		
		div.appendChild(btn);
		div.appendChild(txt);
		document.getElementById("divKat").appendChild(div);	
	}
	
	//Sobald eine Kategorie angedrückt wird, wechselt Umrahmung, setz den Bool in kategorien[]
	function clickKategorie(nr){
		var img = document.getElementById("img_" + nr);
		var pfad = img.src.substring(0,img.src.length-4);
		kategorien[nr] = !kategorien[nr];
		
		
		if(kategorien[nr]){
			img.src = pfad + "_2.png";
			
		}else{
			img.src = pfad.substring(0,pfad.length-2) + ".png";
			
		}
	}
	
	//Sobald über Katg-Bild im Popup Fenster eines Markers gehovert wird
	function hoverKatSymbol(event1,img,specials){
		
		if(specials.length > 0){
			var divi = document.createElement("div");
			var map = document.getElementById("map");
			
			divi.className = "katSymbolDiv";
			divi.id = "katSymbolDivId";
			
			
			
			//Relative Pos. zum Parent Node: https://stackoverflow.com/questions/26423335/elements-coordinates-relative-to-its-parent
			
			var parentPos = map.getBoundingClientRect(),
 		  	 childrenPos = img.getBoundingClientRect(),
   			 relativePos = {};

			relativePos.top = childrenPos.top - parentPos.top,
			relativePos.left = childrenPos.left - parentPos.left;
			
			divi.style.top = relativePos.top;
			divi.style.left = relativePos.left + 35 + "px";
			
			
			var liste = document.createElement("ul");
			
			for(i in specials){
					var listElem = document.createElement("li");
					listElem.appendChild(document.createTextNode(specials[i]));
					liste.appendChild(listElem);			
			}
			
			
			
			divi.appendChild(liste);
			
			
			
			
			map.appendChild(divi);
			
		}
	}
	//Sobald über Katg-Bild im Popup Fenster eines Markers rausgehovert wird
	function hoverOutKatSymbol(){
		
		var divi = document.getElementById("katSymbolDivId");
		var map = document.getElementById("map");
		
		if(divi != null){
			map.removeChild(divi);
		}
		
		
	}
	
	
	
	
	//Anleitungen/hilfstools:
	
	//https://developers.google.com/places/place-id#find-id
	//https://developers.google.com/maps/documentation/javascript/examples/place-details?hl=de
	
	//var labeli = 1;
	
	
	//Fügt eine Einrichtungstandort hinzu
	function addPlace3(name, bGrad, lGrad, adresse, spendenAnnahmen, spendenSpecials, url){
		
		var pos = {lat: bGrad, lng: lGrad};
	
		var marker = new google.maps.Marker({
             map: map,
             position: pos,
			// label: labeli + "",
			 animation: google.maps.Animation.DROP
        });
			
		markers.push(marker);
		
		//labeli++;
		
		
		markerContent.push([name, bGrad, lGrad, adresse, spendenAnnahmen, spendenSpecials, url]); 
				
		
      	google.maps.event.addListener(marker, 'click', function() {
			var num = 0;
			
			for(g in markers){
				if(markers[g] == this){
					num = g;
					break;
				}
			}
		
		
			//markerContent[num][0] == name
			var content = '<div><strong>' + markerContent[num][0] + '</strong><br>';
			
			//markerContent[num][4] == spendenAnnahmen
			var ic = 0;
			for(h in markerContent[num][4]){
			
				
				for(var i = 0; i < katLabels.length; i++){
										
					
					if(markerContent[num][4][h] === katLabels[i]){
						//markerContent[num][5] == spendenSpecials
						
						var overString = "";
						var specialI = markerContent[num][5][ic];
						
						
						
						if(specialI != null){
							ic++;
							var specStringI = "";
						
							for(var j = 0; j < specialI.length; j++){
								specStringI = specStringI + '\'' + specialI[j] + '\'';
								if(j < specialI.length-1){
									specStringI = specStringI + ',';
								}
							
							}
							
							
							overString = 'onmouseout="hoverOutKatSymbol()" onmouseover="hoverKatSymbol(event,this,['+specStringI+']);"';
						}
						
						
						
						content += '<img  src="' + katPaths[i] + '" width = "30px" name="'+ katLabels[i]  + '" '+overString+'>'	
					
					}
					
				}
				
			}
			
			
			//markerContent[num][0] == adresse, markerContent[num][6] == url
			content += '<br>' + markerContent[num][3] + '</div><div class="zurWebsiteDiv">&#x2192<a href="'+ markerContent[num][6] +'">Zur Website</a></div>';
			
			
			
           infowindow.setContent(content);
              infowindow.open(map, this);
			 
        });
	}
	
	var p_c = 0;
	function addPlace(name, place_id, spendenAnnahmen,spendenSpecials, url){
		
		 window.setTimeout(function() {
			
			addPlace2(name, place_id, spendenAnnahmen,spendenSpecials, url);
		 }, p_c*200);

		p_c++;
	}
	
	//Fügt eine Einrichtungstandort hinzu
	function addPlace2(name, place_id, spendenAnnahmen,spendenSpecials, url){
			
		service.getDetails({
          placeId: place_id
        }, function(place, status) {
          //if (status === google.maps.places.PlacesServiceStatus.OK) {
			
			var lng = place.geometry.location.lng();
			var lat = place.geometry.location.lat();
			var nam = place.name;
			
			if(name != null){
				nam = name;	
			}
			
			addPlace3(nam, lat, lng,place.formatted_address.split(",")[0],spendenAnnahmen,spendenSpecials,url);
			
			
			  
		  /*}else{
			alert("Place " + name + " konnte nicht hinzugefügt werden, überprüfe die Place ID! " + place_id)
		  }*/
		});	  
		
	}
	
	
	/*function addPlace(place_id, spendenAnnahmen){
			
		addPlace3(null,place_id, spendenAnnahmen);
		
	}*/
	
	
	//Updated die Marker (Falls zum Beispiel andere Kategorien ausgewählt wurden + LOS)
	function updateMarkers(){
		infowindow.close();
		
		var choosedKatg = [];
		
		for(h in katLabels){
			if(kategorien[h]){
				choosedKatg.push(katLabels[h]);
			}
		}
		
		
		if(choosedKatg.length == 0){
			choosedKatg = katLabels;
		}
		
		
		var canStayList = [];
		
		
		for(i in markers){
			var canStay = false;
			
			var markerI = markers[i];
			var markKat = markerContent[i][4];
			
			for(j in markKat){
				
				for(k in choosedKatg){
					if(markKat[j] === choosedKatg[k]){
						canStay = true;
						break;	
					}
					
				}
								
			}
			
			if(canStay){
					canStayList.push(true);
			}else{
					canStayList.push(false);
			}
			
			
		}	
		
		for(l in canStayList){
			
			
			changeMap(markers[l], canStayList[l], l*200+1)
			
		}
		
			
	}
	//Fügt einen Marker getimed zur Map hinzu
	function changeMap(marker, bool, time){
		
		window.setTimeout(function() {
				if(bool && marker.getMap() != null){
					
				}else{
					marker.setAnimation(google.maps.Animation.DROP);	
					marker.setMap(bool ? map : null);	
				}
				
		}, time);
		
	}
	
	
	/*function addPlace(place_id){
		service.getDetails({
          placeId: place_id
        }, function(place, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            
			var marker = new google.maps.Marker({
              map: map,
              position: place.geometry.location
            });
			
			
            google.maps.event.addListener(marker, 'click', function() {
              infowindow.setContent('<div><strong>' + place.name + '</strong><br>' +
                'Place ID: ' + place.place_id + '<br>' +
                place.formatted_address + '</div>');
              infowindow.open(map, this);
         	 });
       	 }
        }
		);

		
	}*/
	
    //Zur Initierung der Google Map
    function initMap() {
      var bremen = {lat: 53.076320, lng: 8.808581};
	 
		

	  
      map = new google.maps.Map(document.getElementById('map'), {
      		zoom: 12,
			minZoom: 10,
            center: bremen
       });
	   
	   
	   infowindow = new google.maps.InfoWindow();
	   service = new google.maps.places.PlacesService(map);
	   
     /*  var marker = new google.maps.Marker({
           position: bremen,
           map: map
       });*/
	  
addPlace('Verein für Innere Mission in Bremen','ChIJhW9rIQ0osUcRrE3kNWcxOJ0',['Kleidung'],[['Damen-und Herrenmode','Kinderbekleidung','Schuhe']],'https://www.inneremission-bremen.de/startseite/');
addPlace('ProShop Bremen','ChIJ89bxYH4nsUcREksgXBw3boo',['Haushaltswaren','Spielzeug','Bücher','Sonstiges'],[[],[],[],['Textilien']],'http://www.projob-bremen.de/index.php?id=14');
addPlace('ProJob Bremen','ChIJ164EEyoosUcRy6I04KPS6ho',['Möbel','Haushaltswaren'],[[],[]],'http://www.projob-bremen.de/index.php?id=18');
addPlace('Cafe Papagei','ChIJ-3so-BEosUcRPCYq-g-sjY0',['Lebensmittel'],[['Kaffee','Tee','Kekse']],'https://www.inneremission-bremen.de/wohnungslosenhilfe/tagestreffs/cafe_papagei/');
addPlace('frauenzimmer','ChIJa5aoEBYosUcR7-oPi5SZBVM',['Lebensmittel'],[['Kaffee','Tee','Kekse']],'https://www.inneremission-bremen.de/wohnungslosenhilfe/tagestreffs/frauenzimmer/');
addPlace('Bahnhofsmission Bremen','ChIJPW9aWBIosUcRIWbrsm-T2Vo',['Lebensmittel'],[['Kaffee']],'http://www.bahnhofsmission-bremen.de/');
addPlace('Deutsches Rotes Kreuz Kreisverband Bremen e.V.','ChIJMzOAQ4QnsUcR1QxfNKM8QQU',['Kleidung','Bücher'],[[],[]],'http://www.drk-bremen.de/startseite.html');
addPlace('Deutsches Rotes Kreuz Kreisverband Bremen e.V.','ChIJySe4uUnTtkcRAX3DZkNRfs8',['Kleidung'],[[]],'http://www.drk-bremen.de/startseite.html');
addPlace('Die Bremer Suppenengel','ChIJdVHLMOPXsEcR6frrixM3ILg',['Lebensmittel','Kleidung','Sonstiges'],[['Nudeln','Reis','Kaffee','Gewürze','Konserven'],[],['Schlafsäcke','Isomatten','Büromaterial','gebrauchte Smartphones']],'http://www.suppenengel.de/');
addPlace('SOS Kinderdorf','ChIJ1e0jeh8osUcRYXT6fGKqtlM',['Bücher','Spielzeug','Kleidung'],[['Kinderbücher'],['Kinderspielzeug'],['Kinderkleidung']],'http://www.sos-kinderdorf.de/kinderdorf-bremen');
addPlace('SOS Kinderdorf','ChIJIT1y7-bXsEcRlL2yIBkmK6c',['Bücher','Spielzeug','Kleidung'],[['Kinderbücher'],['Kinderspielzeug'],['Kinderkleidung']],'http://www.sos-kinderdorf.de/kinderdorf-bremen');
addPlace('SOS Kinderdorf','ChIJC2LtuasssUcRfK7QtJZ95i8',['Bücher','Spielzeug','Kleidung'],[['Kinderbücher'],['Kinderspielzeug'],['Kinderkleidung']],'http://www.sos-kinderdorf.de/kinderdorf-bremen');
addPlace('MöbellagerNord','ChIJFR1C4a4ssUcRA4l8ZIS8PZg',['Möbel','Haushaltswaren','Elektronik'],[[],['Geschirr','Gläser','Küchenartikel','Lampen','Textilien'],['Kleingeräte']],'https://www.moebellagernord.de/');

addPlace('Recycling-Hof Huchting','ChIJ2fvAOyTWsEcRVzU5p3SESac',['Elektronik','Sonstiges'],[['Computer','Stereoanlagen','Büromachinen','Radio','Heizung','Lüftung'],['Bauelemente','Bauteile','Sanitärartikel','Metalle']],'http://gri-bremen.de/recycling-hoefe/huchting/');
addPlace('Recycling-Hof Findorff','ChIJS7gsNVwosUcR9Bo7JzJFGJY',['Elektronik','Haushaltswaren','Bücher','Sonstiges'],[['Computer','Radio','Toaster','Kaffeemachinen'],['Geschirr','Besteck','Schallplatten','Lampen','Dekorationsartikel'],[],['Metalle','Textilien']],'http://gri-bremen.de/recycling-hoefe/findorff/');
addPlace('Recycling-Hof Hemelingen','ChIJf7Lbr4HYsEcR2Xuf9waqeAc',['Elektronik','Haushaltswaren'],[['Waschmaschinen','Kühl-und Gefrierschränke','Herde','Mikrowellenherde','Nähmaschinen'],['Radios','Fernseher','Computer','Küchengeräte']],'http://gri-bremen.de/recycling-hoefe/hemelingen/');
addPlace('Möbelhaus Oslebshausen','ChIJs-mssGApsUcRfqGHXBnLcGA',['Möbel','Haushaltswaren','Kleidung','Bücher','Sonstiges'],[[],[],[],[],['Wohnaccessoires']],'http://gri-bremen.de/mobelhallen/oslebshausen/');
addPlace('Kaufhaus Hemelingen','ChIJG0WLFn4nsUcRzZnb6Pr6nO8',['Möbel','Elektronik','Kleidung','Bücher','Spielzeug','Haushaltswaren','Sonstiges'],[[],[],[],[],[],[],['Wohnaccessoires','Bilder']],'http://gri-bremen.de/mobelhallen/kaufhaus-hemelingen/');
addPlace('Möbelhalle Kattenturm Mitte','ChIJNf_gtyTYsEcR6wO9qF5qo4I',['Möbel','Kleidung','Bücher','Spielzeug','Haushaltswaren','Sonstiges'],[[],[],[],[],['Haushaltsgeräte'],['Wohnaccessoires','Bilder']],'http://gri-bremen.de/mobelhallen/kattenturm-mitte/');








		
		
		

     }
	 
	 //Checkt die Eingabe des PLZ Eingabefelds
	 //src: https://stackoverflow.com/questions/8354975/how-can-i-limit-possible-inputs-in-a-html5-number-element
	function plzCheck(object) {
    if (object.value.length > object.maxLength){
		object.value = object.value.slice(0, object.maxLength);
	}
	var plzFound = document.getElementById("plzFound");
	
	if(plzToStadtteil(object.value) != null){
		plzFound.innerHTML = "✔";
	}else{
		plzFound.innerHTML = "";
	}
	
	
  }
    
  function isNumeric (evt) {
    var theEvent = evt || window.event;
    var key = theEvent.keyCode || theEvent.which;
	
	//Lösch,entfern, und pfeiltasten 
	if(key == 8 || key == 46 || key == 39 || key == 37){
		return;	
	}
	
    key = String.fromCharCode (key);
	
    var regex = /[0-9]|\./;
    if ( !regex.test(key) ) {
      theEvent.returnValue = false;
      if(theEvent.preventDefault) theEvent.preventDefault();
    }
  }
  
  
 function addAllPLZ(){
	addStadtTeil(28717,53.170694,8.686246);
	addStadtTeil(28719,53.154667,8.701797);
	addStadtTeil(28237,53.122292,8.730002);
	addStadtTeil(28239,53.135102,8.739511);
	addStadtTeil(28357,53.127528,8.864201);
	addStadtTeil(28197,53.096194,8.713175);
	addStadtTeil(28219,53.111571,8.791184);
	addStadtTeil(28359,53.103984,8.861513);
	addStadtTeil(28355,53.097650,8.932582);
	addStadtTeil(28217,53.094305,8.773924);
	addStadtTeil(28215,53.097407,8.809555);
	addStadtTeil(28213,53.096262,8.844588);
	addStadtTeil(28195,53.080842,8.804617);
	addStadtTeil(28209,53.087569,8.828092);
	addStadtTeil(28203,53.074142,8.824178);
	addStadtTeil(28211,53.083145,8.852693);
	addStadtTeil(28205,53.069402,8.844003);
	addStadtTeil(28207,53.065793,8.866263);
	addStadtTeil(28329,53.078580,8.882541);
	addStadtTeil(28327,53.074643,8.921057);
	addStadtTeil(28325,53.068635,8.948931);
	addStadtTeil(28201,53.059496,8.814182);
	addStadtTeil(28259,53.055231,8.736066);
	addStadtTeil(28199,53.060853,8.784807);
	addStadtTeil(28277,53.038870,8.818319);
	addStadtTeil(28279,53.039011,8.849759);
	addStadtTeil(28309,53.044937,8.889094);
	addStadtTeil(28307,53.037959,8.928469);
	addStadtTeil(28777,53.206085,8.525941);
	addStadtTeil(28779,53.193830,8.573819);
	addStadtTeil(28755,53.184524,8.611530);
	addStadtTeil(28757,53.177439,8.632339);
	addStadtTeil(28759,53.167725,8.650905);
}
	 
	 
	 
         </script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDiCHKIxpj5H2bfsFK5VRYI5al3r9ira2E&callback=initMap&libraries=places">
        </script>
</html>