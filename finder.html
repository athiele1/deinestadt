<html>
<head>
<link rel="shortcut icon" type="image/png" href="pics/logo_300.png"/>
<title>Bremen spendet</title>
<meta charset="utf-8"/>
<link rel="stylesheet" type="text/css" href="style.css">
<link href="https://fonts.googleapis.com/css?family=Oswald:400" rel="stylesheet">
<script src="main.js"></script>
</head>
<body>
<div id="divHead"></div>
<div id="divContent">
  <h1>Was möchtest du spenden?</h1>
  <div id="divKat"></div>
  <h1>Deine Postleitzahl:</h1>
  <input type="text"  style="width:80px" id="plzInput" class="noFocus" oninput="plzCheck(this)" max = "99999" maxLength="5" onKeyPress="return isNumeric(event)">
  <span id="plzFound" style="color:green"></span>
  <br><br>
  <input type="button" id="los" class="button1" value="Los!" onClick="los()">
  <br>
  <br>
  <!--<h1>Der "Spenden-Finder" ist noch in Arbeit.</h1>
    
    <div id="div350">
    <img src="pics/tea.png" width="350" height="260">
    Bis dahin heißt es abwarten und Spenden raussuchen.
    </div>-->
  
  <div id="map"></div>
</div>
<div id="divButtom"></div>
</body>
<script>
    var infowindow,service,map;
	
	//Beinhaltet für jede Kategorie ein true/false, je nachdem ob es ausgewählt wurde
	var kategorien = [];
	
	var markers = [];
	var markerKatg = [];
	var markerContent = [];
	
	
    addHeadMenu(document.getElementById("divHead"));
    addButtomMenu(document.getElementById("divButtom"));
    markButton(1);
    
	
	var katLabels = ["Bücher","Elektronik","Möbel","Spielzeug","Haushaltswaren","Kleidung","Lebensmittel"];
	var katPaths = ["buch","elektronik","moebel","spielzeug","haushalt","kleidung","lebensmittel"];
	
	for(var i = 0; i < katPaths.length; i++){
		katPaths[i] = 	pathLabelToPath(katPaths[i]);		
	}
	
	for(var i = 0; i < katLabels.length; i++){
		addKategorie(katLabels[i],katPaths[i]);
			
	}
		
	var stadtteile = [];
	addAllPLZ();
	
	
	
	
	//"Klasse" für Stadteil
 	function Stadtteil(pplz, plgrad, pbgrad){
		this.plz = pplz;
		this.lgrad = plgrad;
		this.bgrad = pbgrad;
	}
	
	function addStadtTeil(plz, lgrad, bgrad){
		
		var si = new Stadtteil(plz, lgrad, bgrad);

		stadtteile.push(si);
	}
	
	
	function los(){
		updateMarkers();
		var plzInput = document.getElementById("plzInput");
		var si = plzToStadtteil(plzInput.value);
		
		if(si != null){
			map.setZoom(13);
			map.setCenter(new google.maps.LatLng(si.lgrad, si.bgrad));	
			
			
		}
		window.scrollTo(0,document.body.scrollHeight);
		
	}
	
	function plzToStadtteil(plz){
		var s = plz.toString();
	
		for(i in stadtteile){
			if(s == stadtteile[i].plz.toString()){
				return 	stadtteile[i];
			}
		}
		
		return null;
	}
	
	
	
	
	function pathLabelToPath(katPath){
		return 	"pics/finder/c_" + katPath + ".png";
		
	}
	
	
	
	function addKategorie(name, pfad){
	
		var nr = kategorien.length;
		
		
		var img = new Image();
		img.src = pfad;
		
		var btn = document.createElement("a");
		btn.name = name;
		btn.href = "JavaScript:clickKategorie(" + nr + ");";
		btn.className = "noFocus";
		
		img.id = "img_" + nr;
		kategorien.push(false);
		
		
		btn.appendChild(img);
		
		
		
		var div = document.createElement("div");
		//div.className = "noFocus";
		
		div.className = "katDiv";
		
		var txt = document.createTextNode(name);
		//txt.style.textAlign = "center";		
		
		
		
		div.appendChild(btn);
		div.appendChild(txt);
		document.getElementById("divKat").appendChild(div);	
	}
	
	function clickKategorie(nr){
		var img = document.getElementById("img_" + nr);
		var pfad = img.src.substring(0,img.src.length-4);
		kategorien[nr] = !kategorien[nr];
		
		
		if(kategorien[nr]){
			img.src = pfad + "_2.png";
			
		}else{
			img.src = pfad.substring(0,pfad.length-2) + ".png";
			
		}
	}
	
	
	function clickKatSymbol(img,specials){
		
	}
	
	
	
	
	//Anleitungen/hilfstools:
	
	//https://developers.google.com/places/place-id#find-id
	//https://developers.google.com/maps/documentation/javascript/examples/place-details?hl=de
	
	//var labeli = 1;
	
	function addPlace3(name, bGrad, lGrad, adresse, spendenAnnahmen, spendenSpecials){
		
		var pos = {lat: bGrad, lng: lGrad};
	
		var marker = new google.maps.Marker({
             map: map,
             position: pos,
			// label: labeli + "",
			 animation: google.maps.Animation.DROP
        });
			
		markers.push(marker);
		markerKatg.push(spendenAnnahmen);
		
		//labeli++;
		
		
		markerContent.push([name, bGrad, lGrad, adresse, spendenAnnahmen, spendenSpecials]); 
				
		
      	google.maps.event.addListener(marker, 'click', function() {
			var num = 0;
			
			for(g in markers){
				if(markers[g] == this){
					num = g;
					break;
				}
			}
		
		
			//markerContent[num][0] == name
			var content = '<div><strong>' + markerContent[num][0] + '</strong><br>';
			
			//markerContent[num][4] == spendenAnnahmen
			for(h in markerContent[num][4]){
			
				var ic = 0;
				for(var i = 0; i < katLabels.length; i++){
										
					
					if(markerContent[num][4][h] === katLabels[i]){
						//markerContent[num][5] == spendenSpecials
						var specialI = markerContent[num][5][ic];
						
						var specStringI = "";
						
						for(var j = 0; j < specialI.length; j++){
							specStringI = specStringI + '\'' + specialI[j] + '\'';
							if(j < specialI.length-1){
								specStringI = specStringI + ',';
							}
							
						}
							
						
						
						
						content += '<img src="' + katPaths[i] + '" width = "30px" name="'+ katLabels[i] +'"   onclick="clickKatSymbol(this,['+specStringI+']);">'	
						ic++;
					}
					
				}
				
			}
			//markerContent[num][0] == adresse
			content += '<br>' + markerContent[num][3] + '</div>';
			
			
           infowindow.setContent(content);
              infowindow.open(map, this);
			 
        });
	}
	
	var p_c = 0;
	function addPlace(name, place_id, spendenAnnahmen,spendenSpecials){
		
		 window.setTimeout(function() {
			
			addPlace2(name, place_id, spendenAnnahmen,spendenSpecials);
		 }, p_c*200);

		p_c++;
	}
	
	
	function addPlace2(name, place_id, spendenAnnahmen,spendenSpecials){
			
		service.getDetails({
          placeId: place_id
        }, function(place, status) {
          //if (status === google.maps.places.PlacesServiceStatus.OK) {
			
			var lng = place.geometry.location.lng();
			var lat = place.geometry.location.lat();
			var nam = place.name;
			
			if(name != null){
				nam = name;	
			}
			
			addPlace3(nam, lat, lng,place.formatted_address.split(",")[0],spendenAnnahmen,spendenSpecials);
			
			
			  
		  /*}else{
			alert("Place " + name + " konnte nicht hinzugefügt werden, überprüfe die Place ID! " + place_id)
		  }*/
		});	  
		
	}
	
	
	/*function addPlace(place_id, spendenAnnahmen){
			
		addPlace3(null,place_id, spendenAnnahmen);
		
	}*/
	
	function updateMarkers(){
		
		var choosedKatg = [];
		
		for(h in katLabels){
			if(kategorien[h]){
				choosedKatg.push(katLabels[h]);
			}
		}
		
		if(choosedKatg.length == 0){
			choosedKatg = katLabels;
		}
		
		
		
		for(i in markers){
			var canStay = false;
			var markerI = markers[i];
			var markKat = markerKatg[i];
			
			for(j in markKat){
				
				for(k in choosedKatg){
					if(markKat[j] === choosedKatg[k]){
						canStay = true;
						break;	
					}
					
				}
				
				if(canStay){
					markerI.setMap(map);
				}else{
					markerI.setMap(null);
				}
			}
			
			
		}		
	}
	
	
	/*function addPlace(place_id){
		service.getDetails({
          placeId: place_id
        }, function(place, status) {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            
			var marker = new google.maps.Marker({
              map: map,
              position: place.geometry.location
            });
			
			
            google.maps.event.addListener(marker, 'click', function() {
              infowindow.setContent('<div><strong>' + place.name + '</strong><br>' +
                'Place ID: ' + place.place_id + '<br>' +
                place.formatted_address + '</div>');
              infowindow.open(map, this);
         	 });
       	 }
        }
		);

		
	}*/
	
    
    function initMap() {
      var bremen = {lat: 53.076320, lng: 8.808581};
	 
		

	  
      map = new google.maps.Map(document.getElementById('map'), {
      		zoom: 12,
			minZoom: 10,
            center: bremen
       });
	   
	   
	   infowindow = new google.maps.InfoWindow();
	   service = new google.maps.places.PlacesService(map);
	   
     /*  var marker = new google.maps.Marker({
           position: bremen,
           map: map
       });*/
	  
	    addPlace('Möbellager Nord','ChIJFR1C4a4ssUcRmvI0n-WW-Ws',['Möbel','Haushaltswaren'],[[],[]]);
	    //addPlace('Recycling-Hof Huchting','ChIJqbUwkyPWsEcRjsVzdGER4qo',[],[]);
		addPlace('Recycling-Hof Findorff','ChIJ-ZAsNVwosUcRZXa0iGgXO7Q',['Haushaltswaren'],[[]]);
		addPlace('Recycling-Hof Hemelingen','ChIJf7Lbr4HYsEcRiRH8CRL9jXU',['Haushaltswaren'],[[]]);
		addPlace('Möbelhaus Oslebshausen','ChIJJTWrsGApsUcRtZ77Vp0JN_g',['Möbel','Haushaltswaren'],[[],[]]);
		addPlace('Kaufhaus Hemelingen','ChIJM7PsFn4nsUcRc0HlMXA2_Qo',['Möbel','Elektronik','Kleidung','Bücher','Spielzeug','Haushaltswaren'],[[],[],[],[],[],[]]);
		addPlace('Möbelhalle Kattenturm Mitte','ChIJla8GyiTYsEcRWjVMAHvEYZc',['Möbel','Kleidung','Bücher','Spielzeug','Haushaltswaren'],[[],[],[],[],[]]);
		addPlace('Verein für Innere Mission in Bremen','ChIJhW9rIQ0osUcRrE3kNWcxOJ0',['Kleidung'],[['Schuhe','Tuch']]);
		addPlace('ProJob Bremen','ChIJ164EEyoosUcRy6I04KPS6ho',['Möbel','Haushaltswaren'],[[],[]]);
		addPlace('Cafe Papagei','ChIJ-3so-BEosUcRPCYq-g-sjY0',['Lebensmittel'],[['Kaffee','Tee','Kekse']]);
		addPlace('frauenzimmer','ChIJa5aoEBYosUcR7-oPi5SZBVM',['Lebensmittel'],[['Kaffee','Tee','Kekse']]);
		//addPlace('Bahnhofsmission Bremen','ChIJPW9aWBIosUcRIWbrsm-T2Vo',[],[]);
		addPlace('Deutsches Rotes Kreuz Kreisverband Bremen e.V.','ChIJMzOAQ4QnsUcR1QxfNKM8QQU',['Kleidung','Bücher'],[[],[]]);
		addPlace('Deutsches Rotes Kreuz Kreisverband Bremen e.V.','ChIJySe4uUnTtkcRAX3DZkNRfs8',['Kleidung'],[[]]);
		addPlace('Bremer Suppenengel','ChIJdVHLMOPXsEcR6frrixM3ILg',['Lebensmittel'],[[]]);
		addPlace('SOS Kinderdorf','ChIJ1e0jeh8osUcRYXT6fGKqtlM',['Spielzeug'],[[]]);
		addPlace('SOS Kinderdorf','ChIJIT1y7-bXsEcRlL2yIBkmK6c',['Spielzeug'],[[]]);
		addPlace('SOS Kinderdorf','ChIJC2LtuasssUcRfK7QtJZ95i8',['Spielzeug'],[[]]);
		
		
		

     }
	 
	 
	 //src: https://stackoverflow.com/questions/8354975/how-can-i-limit-possible-inputs-in-a-html5-number-element
	function plzCheck(object) {
    if (object.value.length > object.maxLength){
		object.value = object.value.slice(0, object.maxLength);
	}
	var plzFound = document.getElementById("plzFound");
	
	if(plzToStadtteil(object.value) != null){
		plzFound.innerHTML = "✔";
	}else{
		plzFound.innerHTML = "";
	}
	
	
  }
    
  function isNumeric (evt) {
    var theEvent = evt || window.event;
    var key = theEvent.keyCode || theEvent.which;
	
	//Lösch,entfern, und pfeiltasten 
	if(key == 8 || key == 46 || key == 39 || key == 37){
		return;	
	}
	
    key = String.fromCharCode (key);
	
    var regex = /[0-9]|\./;
    if ( !regex.test(key) ) {
      theEvent.returnValue = false;
      if(theEvent.preventDefault) theEvent.preventDefault();
    }
  }
  
  
 function addAllPLZ(){
	addStadtTeil(28717,53.170694,8.686246);
	addStadtTeil(28719,53.154667,8.701797);
	addStadtTeil(28237,53.122292,8.730002);
	addStadtTeil(28239,53.135102,8.739511);
	addStadtTeil(28357,53.127528,8.864201);
	addStadtTeil(28197,53.096194,8.713175);
	addStadtTeil(28219,53.111571,8.791184);
	addStadtTeil(28359,53.103984,8.861513);
	addStadtTeil(28355,53.097650,8.932582);
	addStadtTeil(28217,53.094305,8.773924);
	addStadtTeil(28215,53.097407,8.809555);
	addStadtTeil(28213,53.096262,8.844588);
	addStadtTeil(28195,53.080842,8.804617);
	addStadtTeil(28209,53.087569,8.828092);
	addStadtTeil(28203,53.074142,8.824178);
	addStadtTeil(28211,53.083145,8.852693);
	addStadtTeil(28205,53.069402,8.844003);
	addStadtTeil(28207,53.065793,8.866263);
	addStadtTeil(28329,53.078580,8.882541);
	addStadtTeil(28327,53.074643,8.921057);
	addStadtTeil(28325,53.068635,8.948931);
	addStadtTeil(28201,53.059496,8.814182);
	addStadtTeil(28259,53.055231,8.736066);
	addStadtTeil(28199,53.060853,8.784807);
	addStadtTeil(28277,53.038870,8.818319);
	addStadtTeil(28279,53.039011,8.849759);
	addStadtTeil(28309,53.044937,8.889094);
	addStadtTeil(28307,53.037959,8.928469);
	addStadtTeil(28777,53.206085,8.525941);
	addStadtTeil(28779,53.193830,8.573819);
	addStadtTeil(28755,53.184524,8.611530);
	addStadtTeil(28757,53.177439,8.632339);
	addStadtTeil(28759,53.167725,8.650905);
}
	 
	 
	 
         </script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDiCHKIxpj5H2bfsFK5VRYI5al3r9ira2E&callback=initMap&libraries=places">
        </script>
</html>